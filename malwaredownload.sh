#!/bin/bash

#Creating Variables
yesterday=$(date -d "yesterday" '+%Y%m%d')
date=$(date +"%Y%m%d") #display date as yyyymmdd
year=$(date -d "yesterday" +"%Y") #Year as yyyy
month=$(date -d "yesterday" +"%m") #month as mm 03
day=$(date -d "yesterday" +"%d") #day as dd 17
url=https://datalake.abuse.ch/malware-bazaar/daily/${year}-${month}-${day}.zip
yeardir=~/Documents/Maliscious/Malware/${year}/
mondir=~/Documents/Maliscious/Malware/${year}/${month}/
dir=~/Documents/Maliscious/Malware/${year}/${month}/${day}/
mal_dir=~/Documents/Maliscious/Malware/
yara_rule_dir=~/Documents/Yara/Rules/Custom/

###### Create directory for the day

if [ ! -d ${yeardir} ]
	then
		mkdir ${yeardir}
	fi

if [ ! -d ${mondir} ]
	then
		mkdir ${mondir}
	fi

if [ ! -d ${dir} ]
	then
		mkdir ${dir}	
	else
		echo "${dir} exists"
	fi

if [ ! -d ${dir}samples ]
	then
		mkdir ${dir}samples
	else
		echo "${dir}samples exists" 
	fi
	
######################################################
# Download yesterday samples from Malshare    
######################################################

cd ${dir}
wget ${url}

#########################################
###### extract files and run Yara against them
#########################################

unzip -P "infected" -d "samples" "*zip"
/usr/local/bin/yara -w ${yara_rule_dir}*yara ${dir}samples/files/ > ${dir}${date}_Yara_hits_after_generating.txt ######  Run the custom YARA rules against the samples folder and write the output to a file.  the -w is ignore warning

#########Create new YARA signatures based off the day

python3 ~/Documents/yarGen-master/yarGen.py --score --nosuper --excludegood -a "G-Man" -z 10 -r "${date}_samples" -o "${dir}YARA_Signatures_${date}_samples.yara" -m samples

cp ${dir}*yara ~/Documents/Yara/Rules/Custom/


#####################################
# Cleanup Files
######################################

rm -rf samples
